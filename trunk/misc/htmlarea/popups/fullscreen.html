<html>
<head><title>Fullscreen Editor</title>
<style type="text/css">
@import url(../htmlarea.css);
html, body {	margin: 0px; border: 0px; background-color: buttonface; } </style>

<!-- changed for APC-AA by pavelji@ecn.cz
  added script tags for HTMLArea js scripts, because of broken
  dynamic loading
//--> 
<script type="text/javascript" src="../htmlarea.js"></script>
<script type="text/javascript" src="../dialog.js"></script>
<script type="text/javascript" src="../popupwin.js"></script>
<script type="text/javascript" src="../lang/cz.js"></script>

<script type="text/javascript">
// commented out for APC-AA by pavelji@ecn.cz
// reason: broken dynamic loading of javascripts from opener window
/*
// load same scripts that were present in the opener page
var scripts = opener.document.getElementsByTagName("script");
var head = document.getElementsByTagName("head")[0];
for (var i = 0; i < scripts.length; ++i) {
  var script = scripts[i];
  if (typeof script.src != "undefined" && /\S/.test(script.src)) {
//     document.write("<scr" + "ipt type=" + "\"script/javascript\"");
//     document.write(" src=\"../" + script.src + "\"></scr" + "ipt>");     
    var new_script = document.createElement("script");
    if (/^http:/i.test(script.src)) {        
      new_script.src = script.src;
    } else if (script.src) {    
        new_script.src = "../" + script.src;
    }    
    head.appendChild(new_script);
  }
}
*/
</script>

<script type="text/javascript">

var parent_object  = null;
var editor         = null;      // to be initialized later [ function init() ]

/* ---------------------------------------------------------------------- *\
  Function    : 
  Description : 
\* ---------------------------------------------------------------------- */

function _CloseOnEsc(ev) {
  if (document.all) {
    // IE
    ev = window.event;
  }
  if (ev.keyCode == 27) {
    // update_parent();
    window.close();
    return;
  }
}

/* ---------------------------------------------------------------------- *\
  Function    : cloneObject
  Description : copy an object by value instead of by reference
  Usage       : var newObj = cloneObject(oldObj);
\* ---------------------------------------------------------------------- */

function cloneObject(obj) {
  var newObj          = new Object; 

  // check for array objects
  if (obj.constructor.toString().indexOf("function Array(") == 1) {
    newObj = obj.constructor();
  }

  // check for function objects (as usual, IE is fucked up)
  if (obj.constructor.toString().indexOf("function Function(") == 1) {
    newObj = obj; // just copy reference to it
  } else for (var n in obj) {
    var node = obj[n];
    if (typeof node == 'object') { newObj[n] = cloneObject(node); }
    else                         { newObj[n] = node; }
  }
  
  return newObj;
}

/* ---------------------------------------------------------------------- *\
  Function    : resize_editor
  Description : resize the editor when the user resizes the popup
\* ---------------------------------------------------------------------- */

function resize_editor() {  // resize editor to fix window
  var newHeight;
  if (document.all) {
    // IE
    newHeight = document.body.offsetHeight - editor._toolbar.offsetHeight;
    if (newHeight < 0) { newHeight = 0; }
  } else {
    // Gecko
    newHeight = window.innerHeight - editor._toolbar.offsetHeight;
  }
  if (editor.config.statusBar) {
    newHeight -= editor._statusBar.offsetHeight;
  }
  editor._textArea.style.height = editor._iframe.style.height = newHeight + "px";
}

/* ---------------------------------------------------------------------- *\
  Function    : init
  Description : run this code on page load
\* ---------------------------------------------------------------------- */

function init() {
  parent_object      = opener.HTMLArea._object;
  var config         = cloneObject( parent_object.config );
  config.editorURL   = "../";  
  config.width       = "100%";
  config.height      = "100%";

  // change maximize button to minimize button
  config.btnList["popupeditor"] = [ 'Minimize Editor', config.editorURL + 'images/fullscreen_minimize.gif', true,
                                    function() { window.close(); } ];

  // generate editor and resize it
  editor = new HTMLArea("editor", config);
  // changed for APC-AA by pavelji@ecn.cz
  // propagation of AA session Id from main HTMLArea (or normal Textarea) to 
  // fullscreen editor window
  editor.session = opener.HTMLArea._object.session;
  editor.generate();
  editor._iframe.style.width = "100%";
  editor._textArea.style.width = "100%";
  resize_editor();

  editor.doctype = parent_object.doctype;

  // set child window contents and event handlers, after a small delay
  setTimeout(function() {
  /* changed for APC-AA by pavelji@ecn.cz
   * If we work with fullscreen window different (it's not called from HTMLArea by 
     "Edit in Fullscreen" button, but directly from textarea by button), we need
     to make changes in this code. Because our parent_object isn't HTMLArea but
     normal Textarea...
   */  
    if (parent_object.isnormal == "1") { // is fullscreen window called by button?
        editor.setHTML(parent_object._textArea.value);  // yes, we fill content directly
    } else {
        editor.setHTML(parent_object.getInnerHTML()); // no, use HTMLArea functions
    }
    // switch mode if needed
    if (parent_object._mode == "textmode") { editor.setMode("textmode"); }

    // continuously update parent editor window
    setInterval(update_parent, 500);

    // setup event handlers
    document.body.onkeypress = _CloseOnEsc;
    editor._doc.body.onkeypress = _CloseOnEsc;
    editor._textArea.onkeypress = _CloseOnEsc;
    window.onresize = resize_editor;
  }, 333);                      // give it some time to meet the new frame
}

/* ---------------------------------------------------------------------- *\
  Function    : update_parent
  Description : update parent window editor field with contents from child window
\* ---------------------------------------------------------------------- */

function update_parent() {
  // use the fast version
  
  /* changed for APC-AA by pavelji@ecn.cz
   * If we work with fullscreen window different (it's not called from HTMLArea by 
     "Edit in Fullscreen" button, but directly from textarea by button), we need
     to make changes in this code. Because our parent_object isn't HTMLArea but
     normal Textarea...
   */  
  if (parent_object.isnormal == "1") { // is normal textarea?
    // yes: set content directly to opener's textarea
    parent_object._textArea.value = editor.getInnerHTML(); 
  } else {
    // no: opener is HTMLArea, we use it's own function
    parent_object.setHTML(editor.getInnerHTML());
  }
}


</script>
</head>
<body scroll="no" onload="init()" onunload="update_parent()">

<form style="margin: 0px; border: 1px solid; border-color: threedshadow threedhighlight threedhighlight threedshadow;">
<textarea name="editor" id="editor" style="width:100%; height:300px">&nbsp;</textarea>
</form>

</body></html>
