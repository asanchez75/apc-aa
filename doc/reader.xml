<?xml version="1.0" encoding="windows-1250"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
"http://www.oasis-open.org/docbook/xml/4.0/docbookx.dtd">
<article>
  <title>Reader Management</title>

  <articleinfo>
    <date>5.2.2003</date>

    <author>
      <firstname>Jakub</firstname>

      <surname>Adámek</surname>

      <affiliation>
        <orgname>Econnect</orgname>
      </affiliation>
    </author>

    <releaseinfo>$Id$</releaseinfo>

    <revhistory>
      <revision>
        <revnumber>1.6</revnumber>

        <date>9.3.2003</date>

        <revremark>Added the section Sending emails by wizard</revremark>
      </revision>

      <revision>
        <revnumber>1.5</revnumber>

        <date>8.3.2003</date>

        <revremark>Updated Mailman section. Other minor changes.</revremark>
      </revision>

      <revision>
        <revnumber>1.4</revnumber>

        <date>6.3.2003</date>

        <revremark>Updated Alerts specific as the menu is updated and Filters
        are renamed to Selections not to confuse them with Content Pooling
        Filters</revremark>
      </revision>

      <revision>
        <revnumber>1.3</revnumber>

        <date>3.3.2003</date>

        <revremark>Enhanced and corrected the Mailman specific section to
        reflect the recent implementation, it is not yet complete.</revremark>
      </revision>

      <revision>
        <revnumber>1.2</revnumber>

        <date>16.2.2003</date>

        <revremark>The part about Anonymous forms moved to a <ulink
        role="html" url="anonym.html">separate document</ulink>. Enhanced and
        corrected the Alerts specific section to reflect the recent
        implementation.</revremark>
      </revision>

      <revision>
        <revnumber>1.1</revnumber>

        <date>11.2.2003</date>

        <revremark>Added a remark about using several slices (second paragraph
        in &#34;Central point: Slice&#34;). Enhanced and corrected the Auth
        specific section to reflect the recent implementation.</revremark>
      </revision>

      <revision>
        <revnumber>1.0</revnumber>

        <date>5.2.2003</date>
      </revision>
    </revhistory>
  </articleinfo>

  <note>
    <para><emphasis>This file was created from the DocBook XML source. Please
    do modifications in the source, not here.</emphasis></para>
  </note>

  <sect1>
    <title>Basic idea</title>

    <para>Readers are users with no AA admin access. I don&#39;t want to use
    the term <quote>users</quote> because of possible confusion with the AA
    users like Authors and more.</para>

    <para>Several modules may be connected with readers:</para>

    <itemizedlist>
      <listitem>
        <simpara>Alerts, for sending new items by email</simpara>
      </listitem>

      <listitem>
        <simpara>Authorization (Auth), for HTTP authorization via MySQL_Auth</simpara>
      </listitem>

      <listitem>
        <simpara>Mailman, for e-mail discussions</simpara>
      </listitem>

      <listitem>
        <para>AA permissions synchronization, which propagates username and
        password changes to the AA permission system</para>
      </listitem>
    </itemizedlist>

    <para>Readers are identified by email in Alerts and Mailman and by
    username in Auth.</para>
  </sect1>

  <sect1>
    <title>Reader Management Slice</title>

    <para>After a lot of discussing and unhappily also a lot of work to be
    thrown off, we have in Econnect decided the best approach to handle Reader
    management will be a slice. It is so simple: each item belongs to one
    person. The individual settings for Alerts, Auth etc. are added as fields
    to the item design.</para>

    <para>Note this means not one slice but several slices, one for each web
    site which uses Alerts, Auth or Mailman. Readers of different web sites
    are in different slices and thus independent. Slice features like item
    feeding may be used when necessary.</para>

    <para>The minimal slice template named Reader Management Minimal is now a
    part of the sql_update script and consists of:</para>

    <table>
      <title>Fields in the Reader Management Minimal template</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry>Username</entry>

            <entry>Used in the Authorization (Auth) module</entry>
          </row>

          <row>
            <entry>Email</entry>

            <entry>Required for Alerts and Mailman modules. For each Reader
            Management slice either username or email should be flagged as
            required.</entry>
          </row>

          <row>
            <entry>Password</entry>

            <entry>If the web uses Auth, this is the HTTP password. Otherwise
            this password must be filled in the anonymous form every time a
            reader wants to change his or her personal details.</entry>
          </row>

          <row>
            <entry>First / Last name</entry>

            <entry>Not required, may be used to personalize emails.</entry>
          </row>

          <row>
            <entry>Email Confirmed</entry>

            <entry>This box is automatically checked after the reader clicks
            on a link including the Access Code (see below). No reader
            receives any Alert email until it is checked.</entry>
          </row>

          <row>
            <entry><anchor id="access_code" />Access Code</entry>

            <entry>This code is received in emails as a part of a URL. By
            clicking on this URL a reader confirms his or her email address.
            The URL points to reader personal details. On webs not using Auth
            this is the only way to edit personal details.</entry>
          </row>

          <row>
            <entry>Remark</entry>

            <entry>Any remark, may or may not be a part of the personal
            details shown to readers.</entry>
          </row>

          <row>
            <entry>Start date</entry>

            <entry>Membership start, readers are disabled before this point
            for all related modules.</entry>
          </row>

          <row>
            <entry>Expiry date</entry>

            <entry>Membership finish, readers are disabled after this point.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>Slice administrators create new slice based on this template and may
    add any number of further fields, which is the main advantage of using a
    slice for Reader Management.</para>

    <para>The Alerts module adds automatically its own fields, with special
    field IDs linking to the module, e.g. <constant>alerts1....4e4c7</constant>
    for <quote>how often</quote> and Alerts Collection with ID
    <constant>4e4c7</constant>.</para>

    <para>One Reader management slice may be connected with several modules,
    usually belonging to the same web site. Suppose you create a site with
    HTTP restricted access. You may provide an Authorization module and two
    different Alerts Collections. They all link to the same reader group and
    thus use the same Reader management slice.</para>

    <para>In the simplest cases, there will be one Reader management slice +
    one Alerts or Auth module. The Alerts or Auth module will always use
    (almost) directly the slice data.</para>

    <sect2>
      <title><anchor id="wizard_email" />Sending emails by wizard</title>

      <para>On Reader Management slices there appears in the action select box
      a new item: <quote>Send emails wizard</quote>. If you select some items
      (readers) and choose this action, the window is divided in two frames
      with a wizard in the right one.</para>

      <para>The wizard contains hints and links into AA pages. Its steps
      include creating or editing the email template, sending an example email
      to yourself and sending the email to all readers which you selected
      before running the wizard.</para>

      <para>You can use any fields aliases like in any view (index, fulltext
      etc.) </para>
    </sect2>
  </sect1>

  <sect1>
    <title>Editing Reader Info: Anonymous posting form</title>

    <para>As readers do not have access to the AA control panel, they must
    edit their personal details on the <ulink role="html" url="anonym.html">Anonymous
    posting form, described in another document</ulink>.</para>
  </sect1>

  <sect1>
    <title>Module common behaviour</title>

    <para>Only readers in Active bin will receive Alerts, be allowed to pages
    guarded by Authorization etc.</para>

    <para>In special cases, when you want to stop web access for some reader
    (authorization) but don&#39;t want to stop him or her receiving Alerts,
    you must create a dummy authorization group and assign this group to him
    or her.</para>
  </sect1>

  <sect1>
    <title>Module specific behaviour</title>

    <sect2>
      <title>Alerts specific behaviour</title>

      <para>The Alerts module appears like other regular modules in the slice
      select box. It offers these pages:</para>

      <table>
        <title>Alerts menu</title>

        <tgroup cols="2">
          <tbody>
            <row>
              <entry>Settings</entry>

              <entry>Core settings for the Alerts module, see below.</entry>
            </row>

            <row>
              <entry>Selections</entry>

              <entry>Choose which selections you want to show and their order.
              Selections are defined in views of type Alerts Selection Set in
              the slices from which you want to send new items. Each selection
              has a description and a set of the powerful <ulink url="???"><constant>conds[]</constant>
              and <constant>sort[]</constant></ulink> parameters, the same as
              are used with <constant>slice.php3</constant> in search forms.
              Mind that if some item appears in several selections, it will be
              repeated in the mail. Try to make selections mutually exclusive.</entry>
            </row>

            <row>
              <entry>Send emails</entry>

              <entry>You can manually send the daily, weekly or monthly digest
              to all readers. And you can send an example email to yourself to
              see exactly what readers receive.</entry>
            </row>

            <row>
              <entry>Reader Management</entry>

              <entry>Sets the Reader Management Slice which feeds this Alerts.
              Allows to add, delete and refresh the Alerts-specific fields to
              the slice. When you change the list on the Selections page, use
              Sync to refresh the appropriate constant group in the Reader
              Management Slice.</entry>
            </row>

            <row>
              <entry>Email Templates</entry>

              <entry>Allows to edit all email templates.</entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <para>The fields added by Sync with reader slice are:</para>

      <table>
        <title>Alerts specific fields</title>

        <tgroup cols="2">
          <tbody>
            <row>
              <entry>how often</entry>

              <entry>How often the reader receives a digest: instant (each new
              item in one e-mail), daily, weekly, monthly.</entry>
            </row>

            <row>
              <entry>choose selections</entry>

              <entry>Multiple checkboxes allowing to choose which selections
              from the collection the reader wants to read. New parameters of
              the Multiple Checkboxes field Input type allow to view them in a
              table, see the Parameter Wizard.</entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <para>You may show <emphasis>how often</emphasis> or
      <emphasis>choose selections </emphasis>in the anonymous forms or you may
      set defaults by hidden fields.</para>

      <para>The core settings in Alerts Admin - Settings include these special
      fields:</para>

      <table>
        <title>Alerts Settings</title>

        <tgroup cols="2">
          <tbody>
            <row>
              <entry>form URL</entry>

              <entry>The URL to your pages with the <quote>Change personal
              details</quote> form. This URL is used to create the
              <constant>_#COLLFORM</constant> alias.</entry>
            </row>

            <row>
              <entry>welcome email</entry>

              <entry>A link to the email template for a message sent to new
              users on subscription. The edit icon on the right allows you to
              jump to the email edit form.</entry>
            </row>

            <row>
              <entry>alert email</entry>

              <entry>A link to the email template of the alert sent instant /
              daily / ... and containing new items.</entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <para>The email templates (welcome and alert) are stored in the common
      table <constant>email</constant> and are defined using aliases and alias
      functions. This allows a completely free design. The formatted new items
      are added by the <constant>_#FILTERS_</constant> alias. If you want to
      send different texts to readers with different <quote>how often</quote>,
      use the <constant>switch</constant> function on the alias
      <constant>_#HOWOFTEN</constant>. To allow readers to confirm their email
      and change their personal settings, use the alias <constant>_#COLLFORM</constant>,
      which is the URL you filled in Alerts Admin - Settings, with an
      additional 9 letters parameter containing the <link
      linkend="access_code">access code</link>.</para>

      <para>An example of both email types is added by <constant>sql_update</constant>.</para>

      <sect3>
        <title>Tips</title>

        <para><emphasis>Alerts-only reader management: </emphasis>You do not
        need the username, but the email is required. Change these Fields
        settings. Perhaps you even do not need to password-protect the reader
        personal info. Change also the <quote>Allow anonymous posting /
        editing</quote> slice settings.</para>

        <para><emphasis>Filtering readers who are not yet confirmed:
        </emphasis>Change the design of the Item Manager in Slice Admin to
        show the alias <constant>_#MAILCONF</constant>. This alias shows
        <quote>yes</quote> or <quote>no</quote>. But it is created by the
        <constant>f_c</constant> function and the values in the database are 0
        or 1. Thus give <quote>0</quote> and not <quote>no</quote> into the
        Search box.</para>

        <para><emphasis>Filtering readers receiving a selection:</emphasis>
        Add the Alerts Selections to Item Manager. Create an alias using the
        function <constant>f_h</constant> with the parameter
        <constant>,</constant> (comma). You will see the selection IDs
        prefixed by <constant>f</constant>. Now you understand why you should
        enter something like <quote>f45</quote> into the Search box.</para>
      </sect3>

      <sect3>
        <title>Step by step tutorial</title>

        <para>Here is a tutorial, describing in steps how you can try the
        Alerts module. The result does not use Authorization, the personal
        info is protected by a password.</para>

        <orderedlist>
          <listitem>
            <simpara>Update to the new AA version from CVS and run
            <constant>sql_update.php3</constant></simpara>
          </listitem>

          <listitem>
            <simpara>Create <quote>My Readers</quote>:</simpara>

            <orderedlist>
              <listitem>
                <simpara>Create a new slice from the <quote>Reader Management
                Minimal</quote> template with the name <quote>My Readers</quote></simpara>
              </listitem>

              <listitem>
                <simpara>Set <quote>Allow anonymous posting</quote> to
                <quote>Active</quote></simpara>
              </listitem>

              <listitem>
                <simpara>Set <quote>Allow anonymous editing</quote> to
                <quote>All items</quote></simpara>
              </listitem>
            </orderedlist>
          </listitem>

          <listitem>
            <simpara>Create selections:</simpara>

            <orderedlist>
              <listitem>
                <simpara>In your favorite test slice, create a view with type
                <quote>Alerts Digest</quote>. Fill something intelligent into
                the design, particularly the <quote>Odd Rows</quote> field</simpara>
              </listitem>

              <listitem>
                <simpara>Fill the Selection 1 and 2 Description with
                <quote>My Selection 1</quote> and 2. Do not fill
                <constant>conds[]</constant>, you can play with them when you
                are an Alerts-master</simpara>
              </listitem>
            </orderedlist>
          </listitem>

          <listitem>
            <simpara>Create and set Alerts:</simpara>

            <orderedlist>
              <listitem>
                <simpara>Create a new Alerts module</simpara>
              </listitem>

              <listitem>
                <simpara>Fill the name <quote>My Alerts</quote>. Fill the form
                URL with some web folder to which you have access, e.g.
                <constant>http://have_access_to/myalerts.shtml</constant></simpara>
              </listitem>

              <listitem>
                <simpara>Click on Selections and insert My Selection 1 and 2
                into the Alerts</simpara>
              </listitem>

              <listitem>
                <simpara>Click on Sync with reader slice, change to My Readers</simpara>
              </listitem>

              <listitem>
                <simpara>Click on Add or refresh fields. A message
                <quote>2 field(s) added</quote> appears.</simpara>
              </listitem>
            </orderedlist>
          </listitem>

          <listitem>
            <simpara>Create the anonymous form:</simpara>

            <orderedlist>
              <listitem>
                <simpara>Move to My Readers</simpara>
              </listitem>

              <listitem>
                <simpara>In Slice Admin - Fields uncheck Show for Username and
                check Required for Email (<emphasis>this is not default
                because the template serves both for Alerts combined with Auth
                and for standalone Alerts</emphasis>)</simpara>
              </listitem>

              <listitem>
                <simpara>Choose Slice Admin - Anonymous Form Wizard</simpara>
              </listitem>

              <listitem>
                <simpara>Fill the URL similar to <constant>http://have_access_to/myalerts.shtml</constant></simpara>
              </listitem>

              <listitem>
                <simpara>Uncheck all fields except of Email, Password, How
                often and Selections</simpara>
              </listitem>

              <listitem>
                <simpara>Click on Show form and copy the form HTML to the file
                <constant>http://have_access_to/myalerts.shtml</constant></simpara>
              </listitem>
            </orderedlist>
          </listitem>

          <listitem>
            <simpara>Subscribe to Alerts:</simpara>

            <orderedlist>
              <listitem>
                <para>Go to the address <constant>http://have_access_to/myalerts.shtml</constant>
                and fill in your email address, the password <quote>abcde</quote>,
                how often <quote>daily</quote> and choose one of the filters</para>
              </listitem>

              <listitem>
                <para>Click on Send, a message <quote>success: insert</quote>
                appears. You may change your settings and use Send again.</para>
              </listitem>

              <listitem>
                <para>Confirm your subscription: Click on the link received in
                the Welcome email</para>
              </listitem>
            </orderedlist>
          </listitem>

          <listitem>
            <simpara>Send alerts:</simpara>

            <orderedlist>
              <listitem>
                <simpara>Go to My Alerts, Send emails. Choose <quote>daily</quote>
                and click on <quote>Go!</quote> at <quote>Send example</quote>.
                You should receive a digest of all items added in the last 24
                hours to your favorite test slice. If there are no such items,
                add some: click on My Selection 1, this moves you to your
                favorite test slice.</simpara>
              </listitem>

              <listitem>
                <simpara>Try the same with <quote>Send now alerts to all users</quote>.
                Note this will store the time into the database and if you
                click again on this button, no mail will be sent because no
                message was added between the two runs.</simpara>
              </listitem>
            </orderedlist>
          </listitem>

          <listitem>
            <simpara>Add items to your favorite test slice and test that you
            receive them</simpara>
          </listitem>
        </orderedlist>
      </sect3>
    </sect2>

    <sect2>
      <title>Auth specific behaviour</title>

      <sect3>
        <title>Apache module mod_auth_mysql</title>

        <para>The Auth feature (it is not a real module) is meant to be used
        by the <constant>mod_auth_mysql</constant> Apache module. You must
        install this module on your web server to appreciate the Auth feature.
        There are several versions of the module with different option names.
        Find the correct ones in your version. This is the info you will need:</para>

        <table>
          <title>Tables maintained by the Auth feature</title>

          <tgroup cols="2">
            <tbody>
              <row>
                <entry>auth_user</entry>

                <entry>with the fields <quote>username</quote> and
                <quote>passwd</quote></entry>
              </row>

              <row>
                <entry>auth_group</entry>

                <entry>with the fields <quote>username</quote> and
                <quote>groups</quote></entry>
              </row>
            </tbody>
          </tgroup>
        </table>

        <para>Set up Apache and fill correct group info into the
        <constant>.htaccess</constant> files in folders which you want to
        protect. Note the groups you are using here are the groups separated
        by semicolon in the AA constants, see below.</para>
      </sect3>

      <sect3>
        <title>Auth feature</title>

        <para>The Auth administration includes creating membership types
        (meta-groups) and assigning (sub)groups to them. This may be achieved
        with the usage of AA constants, where the constant name is the
        membership type and the constant value are the subgroups assigned to
        individual folders, separated by semicolon.</para>

        <para>For example, if you want to create Standard Membership and
        Privileged Membership, where the first is permitted to folders
        &#34;main&#34; and &#34;search&#34; and the second to &#34;main&#34;,
        &#34;search&#34; and &#34;privileged&#34;, you create these two
        constants:</para>

        <table>
          <title>Membership Constants Example</title>

          <tgroup cols="2">
            <tbody>
              <row>
                <entry><emphasis>Name</emphasis></entry>

                <entry><emphasis>Value</emphasis></entry>
              </row>

              <row>
                <entry>Standard Membership</entry>

                <entry>myreaders_main;myreaders_search</entry>
              </row>

              <row>
                <entry>Privileged Membership</entry>

                <entry>myreaders_main;myreaders_search;myreaders_privileged</entry>
              </row>
            </tbody>
          </tgroup>
        </table>

        <para>The user / membership type assignments are synchronized with
        tables <constant>auth_user</constant> and <constant>auth_group</constant>
        using event handlers for events like updating an item or moving the
        item into another bin. Also you should check <quote>Propagate changes
        into current items</quote> in the constant group because then if you
        change the subgroups, all user-group assignments for that metagroup
        are updated even in the <constant>auth_group</constant> table.</para>

        <para>To avoid the conflict of another Reader Management slice using
        the same subgroup names, I recommend to use some pre- or postfix (like
        <quote>myreaders_</quote> in my example).</para>

        <para>When you have created the constant group, create a field of type
        <quote>Auth Group</quote> and assign the constant group to it.</para>

        <para><anchor id="auth_field_group" />The Auth feature is set on and
        off using a new item in Slice Settings, named <quote>Auth Group Field</quote>,
        with the name of the field mentioned above. This setting is visible
        only in Reader Management slices created from the Reader Management
        Minimal template (<emphasis>exactly, only for slices of type
        <constant>ReaderManagement</constant></emphasis>).</para>

        <para>Only when <quote>Auth Group Field</quote> is filled, the slice
        is synchronized with the auth_user/group tables.</para>

        <para>You may set to which bin new readers are put on subscription
        with the standard &#34;Allow anonymous posting of items&#34; setting.</para>

        <para>Because readers are assigned to items, they may appear in
        Pending or Expired bin depending on Start date and Expiry date
        settings. You should run the script <constant>auth_maintain.php3?maintain_auth=1</constant>
        once a day by cron to automatically add or delete users moved to or
        from the Active bin.</para>
      </sect3>
    </sect2>

    <sect2>
      <title><anchor id="mailman" />Mailman specific behaviour</title>

      <para>You can manage mailing lists with the Mailman feature. The idea is
      to use a directory accessible both to PHP and to mailman. AA maintain
      files with names being the mailing list names, each file contains a list
      of email addresses subscribed to the list, one on a row. Mailman reads
      these files regularly to synchronize the real mailing lists.</para>

      <para>To use this feature, follow these steps:</para>

      <orderedlist>
        <listitem>
          <simpara>create the mailing lists using the mailman interface</simpara>
        </listitem>

        <listitem>
          <simpara>in config.php3, set <constant>$MAILMAN_SYNCHRO_DIR</constant>
          to the directory accessible both to PHP and to mailman, described
          above</simpara>
        </listitem>

        <listitem>
          <simpara>create a new field of type <quote>Mailing Lists</quote> in
          the Reader Management slice</simpara>
        </listitem>

        <listitem>
          <simpara>create a new constant group for this field. The names and
          values of constants in the group are the names of the mailing lists</simpara>
        </listitem>

        <listitem>
          <simpara>set the field type, the default is multiple-checkboxes. You
          can arrange the checkboxes into a table with the parameter wizard</simpara>
        </listitem>

        <listitem>
          <simpara>in Slice Settings, select the field as Mailman Lists Field</simpara>
        </listitem>

        <listitem>
          <simpara>set mailman cron so that it regularly (e.g. every minute)
          updates the real mailing lists using a Unix shell-script like</simpara>

          <screen>LISTSDIR=&#34;/var/www/html/maillists&#34;
MMDIR=&#34;/var/mailman&#34;
for LIST in `find $LISTSDIR/* -newer $MMDIR/data/.lastsync -printf &#34;%f\n&#34;`;
    do
        $MMDIR/bin/sync_members -f $LISTSDIR/$LIST -w=no -a=no $LIST
    done
touch $MMDIR/data/.lastsync</screen>
        </listitem>
      </orderedlist>

      <sect3>
        <title>Mailman: create list</title>

        <para>Another convenience feature is the possibility to create new
        mailing lists from the AA interface. For Reader management slices with
        a field filled in Slice Settings - Mailman Lists Field there appears a
        new option in the menu, <quote>Mailman: create list</quote>. You fill
        the name of the new list, admin email and password. The list name is
        added to the constant group used by the Mailman Lists Field and a
        request row is added to the file <constant>.mailman</constant> in the
        <constant>$MAILMAN_SYNCHRO_DIR</constant> directory. You should run
        another Unix shell-script regularly which executes the requests.</para>

        <para>Tip: If you enable users to subscribe to mailing lists in an
        anonymous form, you must add the new checkbox to that form.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1>
    <title>Discussion - Why to use slice?</title>

    <para>The main reason to use slice was that we need some reader management
    with the possibility to add any new fields. This is exactly what slice
    does. Also, we can use many other nice features already developed for
    slice. And last but not least if we need to improve the current slice
    interface to better support Reader management, this will be useful for all
    other slices as well. This is for example the case of Anonymous forms.</para>
  </sect1>
</article>